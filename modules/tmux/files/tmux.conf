#### ── Basic Options ────────────────────────────────────────────

# Dynamically choose terminfo (tmux-256color if available, otherwise screen-256color)
if-shell 'infocmp tmux-256color >/dev/null 2>&1' \
  'set -g default-terminal "tmux-256color"' \
  'set -g default-terminal "screen-256color"'

# Use the user’s shell for commands
set -g default-shell   "${SHELL}"
set -g default-command "${SHELL}"

# Speed up key sequence recognition and enable focus events
set -s escape-time 10
set -s focus-events on

# Assume UTF-8 support (for tmux < 2.2)
set -q -g status-utf8 on

# Number windows and panes starting at 1
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on

# Monitor background-window activity without flashing the status bar
set -g monitor-activity on    # Notify on activity
set -g visual-activity off    # Don’t flash bar

# Increase scrollback and message display durations
set -g history-limit       5000
set -g display-panes-time    800   # Pane numbers for 0.8 s
set -g display-time         1000   # Messages for 1 s
set -sg repeat-time          300   # 300 ms

# Enable mouse and Vi-style keybinding in copy mode
set -g mouse on
set -g status-keys vi
set -g mode-keys vi

# Place status bar at top and refresh every second
set -g status-position top
set -g status-interval 1

# Automatic window title updates
set -g set-titles on
set -g set-titles-string '#H | #S | CW: #I | #W'


#### ── Appearance ─────────────────────────────────────────

setw -g aggressive-resize on
setw -g automatic-rename  on   # Rename windows to current command
setw -g xterm-keys       on   # Support extended keys
setw -q -g utf8 on             # Force UTF-8 in panes


#### ── Prefix & Buffer Management ──────────────────────────────────

unbind C-a
unbind C-b

set -g prefix C-s
bind-key -N "Send prefix to nested session" -T prefix C-s send-prefix

bind-key -N "List paste buffers" -T prefix b list-buffers
bind-key -N "Paste from buffer" -T prefix p paste-buffer
bind-key -N "Choose buffer and yank to clipboard" -T prefix P choose-buffer 'run-shell "tmux save-buffer -b \"%%%\" - | yank > #{pane_tty}"'

bind-key -N "Edit tmux config" -T prefix e new-window -n "$XDG_CONFIG_HOME/tmux/tmux.conf" "sh -c \"$EDITOR "$XDG_CONFIG_HOME/tmux/tmux.conf" && tmux source-file "$XDG_CONFIG_HOME/tmux/tmux.conf" && tmux display 'Config reloaded'\""
bind-key -N "Reload tmux config" -T prefix r source-file "$XDG_CONFIG_HOME/tmux/tmux.conf" \; display 'Config reloaded'

bind-key -N "Show keybindings and execute" -T prefix ? display-popup -E -w 80% -h 80% "fish -c 'tmux-help'"


#### ── Sessions, Windows & Panes ──────────────────────────────────

bind-key -N "Enter select mode (f s: session, f w: window)" -T prefix f switch-client -T select
bind-key -N "Select session with fzf" -T select s display-popup -E -w 100% -h 100% -x C -y C -T "Select session" "fish -c 'fts'"
bind-key -N "Select window with fzf" -T select w display-popup -E -w 100% -h 100% -x C -y C -T "Select window" "fish -c 'ftw'"

bind-key -N "Session/window switcher (fzf)" -T prefix C-f display-popup -E -w 100% -h 100% -x C -y C -T "Session/Window Switcher" "fish -c 'ftsw'"

bind-key -N "Enter new mode (n s/w/-/|, n c for current path)" -T prefix n switch-client -T new
bind-key -N "Switch to current-path mode" -Tnew c switch-client -T current
bind-key -N "New session with name prompt" -Tnew s command-prompt -I "new-session -c ~ -s "
bind-key -N "New window" -Tnew w new-window
bind-key -N "Split pane vertically" -Tnew - split-window -v
bind-key -N "Split pane horizontally" -Tnew | split-window -h

bind-key -N "New session (keep current path)" -Tcurrent s new-session -c "#{pane_current_path}"
bind-key -N "New window (keep current path)" -Tcurrent w new-window -c "#{pane_current_path}"
bind-key -N "Split vertically (keep current path)" -Tcurrent - split-window -v -c "#{pane_current_path}"
bind-key -N "Split horizontally (keep current path)" -Tcurrent | split-window -h -c "#{pane_current_path}"


#### ── Navigation & Resizing ───────────────────────────────────────

bind-key -N "Select pane left" -T prefix -r h select-pane -L
bind-key -N "Select pane down" -T prefix -r j select-pane -D
bind-key -N "Select pane up" -T prefix -r k select-pane -U
bind-key -N "Select pane right" -T prefix -r l select-pane -R

bind-key -N "Swap pane down" -T prefix > swap-pane -D
bind-key -N "Swap pane up" -T prefix < swap-pane -U

bind-key -N "Resize pane left" -T prefix -r H resize-pane -L 10
bind-key -N "Resize pane down" -T prefix -r J resize-pane -D 10
bind-key -N "Resize pane up" -T prefix -r K resize-pane -U 10
bind-key -N "Resize pane right" -T prefix -r L resize-pane -R 10

bind-key -N "Previous window" -T prefix -r C-h previous-window
bind-key -N "Next window" -T prefix -r C-l next-window
bind-key -N "Last active window" -T prefix Tab last-window
bind-key -N "Swap window left" -T prefix S-Left swap-window -t -1
bind-key -N "Swap window right" -T prefix S-Right swap-window -t +1


#### ── Graphics Protocol Support ───────────────────────────────────

# Allow passthrough for graphics protocols (tmux 3.2+)
# Enables kitty graphics protocol via unicode placeholders in Ghostty
# Note: This is a workaround, not official support. May cause issues with large images.
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM


#### ── Copy Mode, OSC52 & Clipboard ─────────────────────────────────

# Enable OSC 52 clipboard integration (tmux 3.2+)
# This allows tmux to set the clipboard via escape sequences
set -s set-clipboard on

# Set copy-command for consistent clipboard handling (tmux 3.2+)
# Prioritize yank command if available for OSC 52 support
if -b 'command -v yank >/dev/null 2>&1' \
  'set -s copy-command "yank > #{pane_tty}"'

bind-key -N "Enter copy mode" -T prefix Enter copy-mode

# Mouse drag: copy selection without leaving copy mode
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear

# Vi-style in copy mode
run -b 'tmux bind -N "Begin selection" -T copy-mode-vi v send -X begin-selection'
run -b 'tmux bind -N "Copy selection" -T copy-mode-vi y send -X copy-selection'
run -b 'tmux bind -N "Copy to system clipboard" -T copy-mode-vi Y send -X copy-pipe-and-cancel "tmux save-buffer - | yank > #{pane_tty}"'
run -b 'tmux bind -N "Toggle rectangle selection" -T copy-mode-vi C-v send -X rectangle-toggle'

# When scrolling with the mouse wheel, enter copy mode automatically
# if not already in it. This helps to preserve the scroll position.
bind-key -T root WheelUpPane if-shell -F -t = "#{pane_in_mode}" "send-keys -M" "copy-mode -e"

#### ── Plugins ───────────────────────────────────────
# Plugins are managed by home-manager (see modules/tmux/default.nix)
# - tmux-battery
# - tmux-online-status
# - tmux-cpu
# - tmux-prefix-highlight
# - tmux-copy-pane
